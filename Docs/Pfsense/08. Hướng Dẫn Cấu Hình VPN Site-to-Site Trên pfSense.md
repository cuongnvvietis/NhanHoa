# Hướng Dẫn Cấu Hình VPN Site-to-Site Trên pfSense

Tài liệu này cung cấp hướng dẫn chi tiết để cấu hình kết nối VPN site-to-site hai chiều giữa hai thiết bị pfSense, Site A và Site B. Hãy làm theo các bước dưới đây để đảm bảo cấu hình thành công.

## Bước 1: Cấu Hình VPN Từ Site A Đến Site B

### 1.1 Cấu Hình Phase 1 Tại Site A
#### Thông Tin Chung
- **Description**: Nhập mô tả cho kết nối, ví dụ: `Tunnel to site B`.
- **IKE ID**: Sử dụng ID mặc định hoặc chỉnh sửa để phân biệt với các kết nối khác.

#### Cấu Hình IKE Endpoint
- **Key Exchange Version**: Chọn **IKEv2**.
- **Internet Protocol**: Chọn **IPv4**.
- **Interface**: Chọn **WAN**.
- **Remote Gateway**: Nhập địa chỉ IP công cộng của Site B.

#### Phase 1 Proposal (Xác Thực)
- **Authentication Method**: Chọn **Mutual PSK** (Pre-Shared Key).
- **My Identifier**: Chọn **My IP Address**.
- **Peer Identifier**: Chọn **Peer IP Address**.
- **Pre-Shared Key**: Nhập khóa chia sẻ bảo mật, ví dụ: `123456`.
![Command Prompt](https://github.com/cuongnvvietis/NhanHoa/blob/main/Docs/Picture/Pfsense/15.png)
#### Phase 1 Proposal (Thuật Toán Mã Hóa)
- **Encryption Algorithm**:
  - **Algorithm**: **AES**.
  - **Key Length**: **256 bits**.
  - **Hash**: **SHA256**.
  - **DH Group**: **14 (2048 bit)**.

#### Expiration and Replacement (Hết Hạn và Thay Thế)
- **Lifetime**: `28800` giây (8 giờ).
- **Rekey Time**: `25920` giây.
- **Reauth Time**: `0`.
- **Rand Time**: `2880` giây.
![Command Prompt](https://github.com/cuongnvvietis/NhanHoa/blob/main/Docs/Picture/Pfsense/16.png)
### 1.2 Cấu Hình Phase 2 Tại Site A
#### Thêm Phase 2
Nhấn **Add P2** để tạo một Phase 2 mới.

#### Thông Tin Chung
- **Mode**: Chọn **Tunnel**.
- **Local Subnet**: Chọn mạng nội bộ (ví dụ: **VLAN80**).
- **Remote Subnet**: Nhập dải mạng từ phía Site B mà bạn muốn kết nối (ví dụ: **10.10.90.0/24**).

#### Phase 2 Proposal (Thuật Toán Mã Hóa)
- **P2 Transforms**: **AES256-GCM (128 bits)**.
- **P2 Protocol**: Chọn **ESP**.

#### Expiration and Replacement
- **Lifetime**: `3600` giây (1 giờ).
![Command Prompt](https://github.com/cuongnvvietis/NhanHoa/blob/main/Docs/Picture/Pfsense/17.png)

## Bước 2: Cấu Hình VPN Từ Site B Đến Site A

### 2.1 Cấu Hình Phase 1 Tại Site B
#### Thông Tin Chung
- **Description**: Nhập mô tả cho kết nối, ví dụ: `Tunnel to site A`.
- **IKE ID**: Sử dụng ID để phân biệt với các kết nối khác.

#### Cấu Hình IKE Endpoint
- **Key Exchange Version**: Chọn **IKEv2**.
- **Internet Protocol**: Chọn **IPv4**.
- **Interface**: Chọn **WAN**.
- **Remote Gateway**: Nhập địa chỉ IP công cộng của Site A.

#### Phase 1 Proposal (Xác Thực)
- **Authentication Method**: Chọn **Mutual PSK**.
- **My Identifier**: Chọn **My IP Address**.
- **Peer Identifier**: Chọn **Peer IP Address**.
- **Pre-Shared Key**: Nhập khóa chia sẻ bảo mật, phải giống với Site A (ví dụ: `123456`).
![Command Prompt](https://github.com/cuongnvvietis/NhanHoa/blob/main/Docs/Picture/Pfsense/18.png)
#### Phase 1 Proposal (Thuật Toán Mã Hóa)
- **Encryption Algorithm**:
  - **Algorithm**: **AES**.
  - **Key Length**: **256 bits**.
  - **Hash**: **SHA256**.
  - **DH Group**: **14 (2048 bit)**.

#### Expiration and Replacement (Hết Hạn và Thay Thế)
- **Lifetime**: `28800` giây.
- **Rekey Time**: `25920` giây.
- **Reauth Time**: `0`.
- **Rand Time**: `2880` giây.
![Command Prompt](https://github.com/cuongnvvietis/NhanHoa/blob/main/Docs/Picture/Pfsense/19.png)

### 2.2 Cấu Hình Phase 2 Tại Site B
#### Thêm Phase 2
Nhấn **Add P2** để tạo Phase 2 mới.

#### Thông Tin Chung
- **Mode**: Chọn **Tunnel**.
- **Local Subnet**: Chọn mạng nội bộ (ví dụ: **10.10.90.0/24**).
- **Remote Subnet**: Nhập dải mạng từ phía Site A mà bạn muốn kết nối (ví dụ: **VLAN80**).

#### Phase 2 Proposal (Thuật Toán Mã Hóa)
- **P2 Transforms**: **AES256-GCM (128 bits)**.
- **P2 Protocol**: Chọn **ESP**.

#### Expiration and Replacement
- **Lifetime**: `3600` giây.
![Command Prompt](https://github.com/cuongnvvietis/NhanHoa/blob/main/Docs/Picture/Pfsense/20.png)
## Bước 3: Kích Hoạt Và Kiểm Tra Kết Nối VPN
- Bật các mục Phase 1 và Phase 2 ở cả Site A và Site B.
- Kiểm tra kết nối dưới **Status > IPsec** để đảm bảo kết nối đã được thiết lập thành công.
- Đảm bảo rằng các mạng ở Site A và Site B có thể giao tiếp với nhau.

### Ghi Chú Quan Trọng
- **Khóa Chia Sẻ Bảo Mật (Pre-Shared Key)** phải giống nhau ở cả hai phía của kết nối.
- **Các Quy Tắc Firewall**: Đảm bảo rằng các quy tắc firewall đã được cấu hình để cho phép lưu lượng IPsec từ cả hai phía.
- **Kiểm Tra Subnet**: Đảm bảo rằng các dải mạng không bị trùng giữa hai site để tránh xung đột.

## Ảnh Hướng Dẫn
Sử dụng các ảnh chụp màn hình được cung cấp để có thêm chi tiết về các bước cấu hình từng mục.

