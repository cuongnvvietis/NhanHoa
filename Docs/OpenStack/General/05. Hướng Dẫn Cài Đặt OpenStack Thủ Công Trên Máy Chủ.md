# Hướng Dẫn Cài Đặt OpenStack Thủ Công Trên Máy Chủ

## Mục lục
- [Cấu hình mạng và cài đặt tiện ích cơ bản](#cấu-hình-mạng-và-cài-đặt-tiện-ích-cơ-bản)
- [Cài đặt và cấu hình MariaDB](#cài-đặt-và-cấu-hình-mariadb)
- [Cài đặt RabbitMQ](#cài-đặt-rabbitmq)
- [Cài đặt Memcached](#cài-đặt-memcached)
- [Cài đặt etcd](#cài-đặt-etcd)
- [Cài đặt Keystone (Identity)](#cài-đặt-keystone-identity)
- [Cài đặt Glance (Image Service)](#cài-đặt-glance-image-service)
- [Cài đặt Nova (Compute Service)](#cài-đặt-nova-compute-service)
- [Cài đặt Neutron (Network Service)](#cài-đặt-neutron-network-service)
- [Cài đặt Cinder (Block Storage Service)](#cài-đặt-cinder-block-storage-service)
- [Cài đặt Horizon (Dashboard)](#cài-đặt-horizon-dashboard)

## Cấu hình mạng và cài đặt tiện ích cơ bản
1. Sửa file `/etc/hosts`:
    ```bash
    sudo vim /etc/hosts
    ```
    Xóa dòng `127.0.1.1 controller` nếu có, và thêm các dòng:
    ```
    172.16.2.9 controller
    172.16.2.10 compute1
    172.16.2.16 block1
    ```

2. Sửa file `/etc/default/grub`:
    ```bash
    sudo vim /etc/default/grub
    ```
    Thêm dòng sau vào:
    ```
    GRUB_CMDLINE_LINUX="net.ifnames=0 biosdevname=0"
    ```
    Chạy lệnh:
    ```bash
    sudo update-grub
    sudo reboot
    ```

3. Cấu hình các giao diện mạng:
    ```bash
    sudo vim /etc/network/interfaces
    ```
    Thêm các cấu hình sau:
    ```
    auto eth0
    iface eth0 inet static
      address 172.16.2.9
      netmask 255.255.240.0
      dns-nameservers 8.8.8.8

    auto eth1
    iface eth1 inet manual
      up ip link set dev eth1 up
      down ip link set dev eth1 down

    auto eth2
    iface eth2 inet dhcp
    ```

4. Cài đặt tiện ích cơ bản:
    ```bash
    sudo apt update
    sudo apt install vim glances curl
    sudo apt upgrade -y
    ```

## Cài đặt và cấu hình MariaDB
1. Cài đặt MariaDB:
    ```bash
    sudo apt install mariadb-server python-pymysql
    ```

2. Sửa file cấu hình `/etc/mysql/mariadb.conf.d/99-openstack.cnf`:
    ```bash
    sudo vim /etc/mysql/mariadb.conf.d/99-openstack.cnf
    ```
    Thêm các dòng sau:
    ```
    [mysqld]
    bind-address = 172.16.2.9
    default-storage-engine = innodb
    innodb_file_per_table = on
    max_connections = 4096
    collation-server = utf8_general_ci
    character-set-server = utf8
    ```

3. Khởi động lại MariaDB và bảo mật:
    ```bash
    sudo service mysql restart
    sudo mysql_secure_installation
    ```

## Cài đặt RabbitMQ
1. Cài đặt RabbitMQ:
    ```bash
    sudo apt install rabbitmq-server
    ```

2. Tạo người dùng `openstack`:
    ```bash
    sudo rabbitmqctl add_user openstack openstack
    sudo rabbitmqctl set_permissions openstack ".*" ".*" ".*"
    ```

## Cài đặt Memcached
1. Cài đặt Memcached:
    ```bash
    sudo apt install memcached python-memcache
    ```

2. Cấu hình địa chỉ IP trong `/etc/memcached.conf`:
    ```bash
    sudo vim /etc/memcached.conf
    ```
    Thêm dòng sau:
    ```
    -l 172.16.2.9
    ```

3. Khởi động lại dịch vụ:
    ```bash
    sudo service memcached restart
    ```

## Cài đặt etcd
1. Tạo người dùng và thư mục cho etcd:
    ```bash
    sudo groupadd --system etcd
    sudo useradd --home-dir "/var/lib/etcd" --system --shell /bin/false -g etcd etcd
    sudo mkdir -p /etc/etcd /var/lib/etcd
    sudo chown etcd:etcd /etc/etcd /var/lib/etcd
    ```

2. Tải và cài đặt etcd:
    ```bash
    ETCD_VER=v3.2.7
    curl -L https://github.com/coreos/etcd/releases/download/${ETCD_VER}/etcd-${ETCD_VER}-linux-amd64.tar.gz -o /tmp/etcd.tar.gz
    tar xzvf /tmp/etcd.tar.gz -C /tmp --strip-components=1
    sudo cp /tmp/etcd /usr/bin/etcd
    sudo cp /tmp/etcdctl /usr/bin/etcdctl
    ```

3. Cấu hình etcd trong `/etc/etcd/etcd.conf.yml`:
    ```yaml
    name: controller
    data-dir: /var/lib/etcd
    initial-cluster-state: 'new'
    initial-cluster-token: 'etcd-cluster-01'
    initial-cluster: controller=http://172.16.2.9:2380
    initial-advertise-peer-urls: http://172.16.2.9:2380
    advertise-client-urls: http://172.16.2.9:2379
    listen-peer-urls: http://0.0.0.0:2380
    listen-client-urls: http://172.16.2.9:2379
    ```

4. Khởi động dịch vụ etcd:
    ```bash
    sudo systemctl enable etcd
    sudo systemctl start etcd
    ```

## Cài đặt Keystone (Identity)
1. Tạo cơ sở dữ liệu Keystone:
    ```bash
    sudo mysql
    CREATE DATABASE keystone;
    GRANT ALL PRIVILEGES ON keystone.* TO 'keystone'@'localhost' IDENTIFIED BY 'openstack';
    GRANT ALL PRIVILEGES ON keystone.* TO 'keystone'@'%' IDENTIFIED BY 'openstack';
    ```

2. Cài đặt Keystone:
    ```bash
    sudo apt install keystone apache2 libapache2-mod-wsgi
    ```

3. Cấu hình truy cập cơ sở dữ liệu trong `/etc/keystone/keystone.conf`:
    ```bash
    sudo crudini --set /etc/keystone/keystone.conf database connection mysql+pymysql://keystone:openstack@controller/keystone
    sudo crudini --set /etc/keystone/keystone.conf token provider fernet
    ```

4. Đồng bộ cơ sở dữ liệu Keystone:
    ```bash
    sudo keystone-manage db_sync
    ```

5. Cài Đặt và Cấu Hình Các Gói
    ```bash
    apt install keystone apache2 libapache2-mod-wsgi crudini -y
    ```
6. Cấu Hình Keystone Để Truy Cập Database

    crudini --set /etc/keystone/keystone.conf database connection mysql+pymysql://keystone:openstack@controller/keystone
7. Cấu Hình Nhà Cung Cấp Fernet Token

    crudini --set /etc/keystone/keystone.conf token provider fernet
8. Đồng Bộ Database Keystone

    su -s /bin/sh -c "keystone-manage db_sync" keystone
9. Khởi Tạo Repositories Fernet

    keystone-manage fernet_setup --keystone-user keystone --keystone-group keystone
    keystone-manage credential_setup --keystone-user keystone --keystone-group keystone
10. Bootstrap Dịch Vụ Identity

    keystone-manage bootstrap --bootstrap-password openstack \
      --bootstrap-admin-url http://controller:35357/v3/ \
      --bootstrap-internal-url http://controller:5000/v3/ \
      --bootstrap-public-url http://controller:5000/v3/ \
      --bootstrap-region-id RegionOne
11. Cấu Hình Apache
Sửa tệp /etc/apache2/apache2.conf và thêm dòng sau:

    ServerName controller
Sau đó, khởi động lại dịch vụ Apache:

    service apache2 restart
12. Tạo File admin-openrc
Tạo file admin-openrc trong thư mục Home và thêm các dòng sau:

    export OS_PROJECT_DOMAIN_NAME=Default
    export OS_USER_DOMAIN_NAME=Default
    export OS_PROJECT_NAME=admin
    export OS_USERNAME=admin
    export OS_PASSWORD=openstack
    export OS_AUTH_URL=http://controller:35357/v3
    export OS_IDENTITY_API_VERSION=3
    export OS_IMAGE_API_VERSION=2
13. Tạo File demo-openrc
Tạo file demo-openrc và thêm các dòng sau:

    export OS_PROJECT_DOMAIN_NAME=Default
    export OS_USER_DOMAIN_NAME=Default
    export OS_PROJECT_NAME=demo
    export OS_USERNAME=demo
    export OS_PASSWORD=openstack
    export OS_AUTH_URL=http://controller:5000/v3
    export OS_IDENTITY_API_VERSION=3
    export OS_IMAGE_API_VERSION=2
14. Kiểm Tra Keystone
Thực hiện lệnh sau để kiểm tra:
    . admin-openrc
    openstack token issue
15. Tạo Project, User và Role

    . admin-openrc
    openstack project create --domain default --description "Service Project" service
    openstack project create --domain default --description "Demo Project" demo
    openstack user create --domain default --password openstack demo
    openstack role create user
    openstack role add --project demo --user demo user
16. Kiểm Tra User Demo

    . demo-openrc
    openstack token issue
    
## 3. Cài Đặt Glance (Image Service)
1. Tạo Database Glance

        sudo su
        mysql
        CREATE DATABASE glance;
        GRANT ALL PRIVILEGES ON glance.* TO 'glance'@'localhost' IDENTIFIED BY 'openstack';
        GRANT ALL PRIVILEGES ON glance.* TO 'glance'@'%' IDENTIFIED BY 'openstack';
        EXIT;
2. Tạo User Glance và Cấu Hình

    . admin-openrc
    openstack user create --domain default --password openstack glance
    openstack role add --project service --user glance admin
3. Tạo Dịch Vụ và Endpoint Glance

    openstack service create --name glance --description "OpenStack Image" image
    openstack endpoint create --region RegionOne image public http://controller:9292
    openstack endpoint create --region RegionOne image internal http://controller:9292
    openstack endpoint create --region RegionOne image admin http://controller:9292
4. Cài Đặt và Cấu Hình Glance

    apt update -y
    apt install glance -y
Sửa tệp /etc/glance/glance-api.conf:

    crudini --set /etc/glance/glance-api.conf database connection mysql+pymysql://glance:openstack@controller/glance
    crudini --set /etc/glance/glance-api.conf keystone_authtoken auth_uri http://controller:5000
    crudini --set /etc/glance/glance-api.conf keystone_authtoken memcached_servers controller:11211
    crudini --set /etc/glance/glance-api.conf keystone_authtoken auth_type password
    crudini --set /etc/glance/glance-api.conf keystone_authtoken project_domain_name default
    crudini --set /etc/glance/glance-api.conf keystone_authtoken user_domain_name default
    crudini --set /etc/glance/glance-api.conf keystone_authtoken project_name service
    crudini --set /etc/glance/glance-api.conf keystone_authtoken username glance
    crudini --set /etc/glance/glance-api.conf keystone_authtoken password openstack
    crudini --set /etc/glance/glance-api.conf glance_store stores "file,http"
    crudini --set /etc/glance/glance-api.conf glance_store default_store file
    crudini --set /etc/glance/glance-api.conf glance_store filesystem_store_datadir /var/lib/glance/images/
5. Đồng Bộ Database và Khởi Động Dịch Vụ Glance

    su -s /bin/sh -c "glance-manage db_sync" glance
    service glance-registry restart
    service glance-api restart
6. Kiểm Tra Hoạt Động Glance

    . admin-openrc
    wget http://download.cirros-cloud.net/0.3.5/cirros-0.3.5-x86_64-disk.img
    openstack image create cirros3.5 --file cirros-0.3.5-x86_64-disk.img --disk-format qcow2 --container-format bare --public
    openstack image list

